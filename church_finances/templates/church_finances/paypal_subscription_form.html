{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Your Subscription - Church Books{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Complete Your Subscription</h1>
        <p class="text-gray-600">You've selected the <strong>{{ selected_package|title }}</strong> plan</p>
        <p class="text-3xl font-bold text-blue-600 mt-2">${{ package_price|floatformat:0 }}/year</p>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-800{% elif message.tags == 'success' %}bg-green-50 text-green-800{% else %}bg-blue-50 text-blue-800{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Main Form Container -->
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm">
        <form method="post" action="{% url 'paypal_create_subscription' %}" class="p-6">
            {% csrf_token %}
            
            <!-- Personal Information Section -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user text-blue-600 mr-3"></i>
                    Your Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="first_name" name="first_name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="last_name" name="last_name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="email" name="email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                        <input type="tel" id="phone_number" name="phone_number" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="mt-6">
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Your Role in the Church *</label>
                    <select id="role" name="role" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select your role</option>
                        <option value="admin">Church Admin</option>
                        <option value="pastor">Pastor</option>
                        <option value="assistant_pastor">Assistant Pastor</option>
                        <option value="treasurer">Treasurer</option>
                        <option value="deacon">Deacon</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">Select your primary role in the church organization</p>
                </div>
            </div>

            <!-- Dashboard Login Credentials Section -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-key text-blue-600 mr-3"></i>
                    Dashboard Login Credentials
                </h3>
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-400">
                    <p class="text-sm text-blue-800 flex items-start">
                        <i class="fas fa-info-circle text-blue-600 mr-2 mt-0.5 flex-shrink-0"></i>
                        These credentials will be used to access your church dashboard after subscription approval.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                        <input type="text" id="username" name="username" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Choose a unique username">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                        <input type="password" id="password" name="password" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Create a strong password">
                    </div>
                </div>
                
                <div class="mt-6">
                    <label for="password_confirm" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password *</label>
                    <input type="password" id="password_confirm" name="password_confirm" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Re-enter your password">
                    <p class="text-xs text-gray-500 mt-2">
                        Password must be at least 8 characters long and contain a mix of letters, numbers, and symbols.
                    </p>
                </div>
            </div>

            <!-- Church Information Section -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-church text-blue-600 mr-3"></i>
                    Church Information
                </h3>
                
                <div class="space-y-6">
                    <div>
                        <label for="church_name" class="block text-sm font-medium text-gray-700 mb-2">Church Name *</label>
                        <input type="text" id="church_name" name="church_name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="church_address" class="block text-sm font-medium text-gray-700 mb-2">Church Address *</label>
                        <textarea id="church_address" name="church_address" rows="3" required 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="church_phone" class="block text-sm font-medium text-gray-700 mb-2">Church Phone *</label>
                            <input type="tel" id="church_phone" name="church_phone" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="church_email" class="block text-sm font-medium text-gray-700 mb-2">Church Email *</label>
                            <input type="email" id="church_email" name="church_email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label for="church_website" class="block text-sm font-medium text-gray-700 mb-2">Church Website <span class="text-gray-400">(Optional)</span></label>
                        <input type="url" id="church_website" name="church_website" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="https://yourchurch.com">
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="bg-white rounded-lg p-6 border-t border-gray-200">
                <div class="flex flex-col space-y-4">
                    <!-- Main Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                        <a href="{% url 'subscription' %}" 
                           class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Plans
                        </a>
                        <button type="submit" name="payment_method" value="paypal"
                                class="inline-flex items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            <i class="fab fa-paypal mr-2"></i>
                            Continue to PayPal
                        </button>
                    </div>
                    
                    <!-- Offline Payment Option -->
                    <div class="text-center border-t pt-6">
                        <p class="text-sm text-gray-600 mb-4">Or pay offline with check/bank transfer</p>
                        <button type="submit" name="payment_method" value="offline" id="offline-payment-btn"
                               class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                            <i class="fas fa-file-invoice mr-2"></i>
                            Pay Offline (Pending Approval)
                        </button>
                        <p class="text-xs text-gray-500 mt-3 max-w-md mx-auto">
                            Your account will be created and await admin approval and payment confirmation
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password confirmation validation
    const password = document.getElementById('password');
    const passwordConfirm = document.getElementById('password_confirm');
    const paypalButton = document.querySelector('button[value="paypal"]');
    
    function validatePasswords() {
        if (password.value && passwordConfirm.value) {
            if (password.value !== passwordConfirm.value) {
                passwordConfirm.setCustomValidity('Passwords do not match');
                passwordConfirm.classList.add('border-red-500', 'focus:ring-red-500');
                passwordConfirm.classList.remove('border-gray-300', 'focus:ring-blue-500');
                if (paypalButton) paypalButton.disabled = true;
            } else {
                passwordConfirm.setCustomValidity('');
                passwordConfirm.classList.remove('border-red-500', 'focus:ring-red-500');
                passwordConfirm.classList.add('border-gray-300', 'focus:ring-blue-500');
                if (paypalButton) paypalButton.disabled = false;
            }
        }
    }
    
    if (password && passwordConfirm) {
        password.addEventListener('input', validatePasswords);
        passwordConfirm.addEventListener('input', validatePasswords);
    }
    
    // Username validation
    const username = document.getElementById('username');
    if (username) {
        username.addEventListener('input', function() {
            const validUsername = /^[a-zA-Z0-9_-]+$/.test(this.value);
            if (this.value && !validUsername) {
                this.setCustomValidity('Username can only contain letters, numbers, underscores, and hyphens');
                this.classList.add('border-red-500', 'focus:ring-red-500');
                this.classList.remove('border-gray-300', 'focus:ring-blue-500');
            } else {
                this.setCustomValidity('');
                this.classList.remove('border-red-500', 'focus:ring-red-500');
                this.classList.add('border-gray-300', 'focus:ring-blue-500');
            }
        });
    }
    
    // Offline payment confirmation
    const offlineBtn = document.getElementById('offline-payment-btn');
    if (offlineBtn) {
        offlineBtn.addEventListener('click', function(e) {
            const confirmed = confirm('Are you sure you want to register for offline payment? Your account will be created and await admin approval. You will receive payment instructions after approval.');
            if (!confirmed) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
